worker_processes  1;

events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;

    keepalive_timeout  65;

    gzip  on;
	
    proxy_cache_path /data/nginx/cache levels=1:2 keys_zone=my_cache:15m max_size=1g use_temp_path=off;

    server {
        listen       80;
        server_name  localhost;

        location / {
            proxy_cache my_cache;
            proxy_pass http://server:3000;
            proxy_cache_key "$request_method $scheme$proxy_host$uri$is_args$args";
            proxy_cache_methods GET HEAD;
            proxy_cache_lock off; # only one upstream request at once for the same resource
            proxy_cache_use_stale off;
            proxy_cache_background_update on;
            proxy_cache_revalidate off; # revalidate stale data using if-modified-since and etag
            proxy_pass_request_body on;
            proxy_pass_request_headers on;
            add_header X-Proxy-Cache $upstream_cache_status;
        }

        location /ws {
            proxy_pass http://server:3001;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

    }

}

